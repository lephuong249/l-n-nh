generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "mongodb"
    url      = env("DATABASE_URL")
}

// ==============================================
// USER & AUTHENTICATION
// ============================================

model User {
    id          String   @id @default(auto()) @map("_id") @db.ObjectId
    userName    String // Giữ userName đơn giản
    email       String
    password    String?
    phoneNumber String? // Đổi từ phone -> phoneNumber cho consistent
    avatar      String?
    role        Role     @default(CUSTOMER)
    isActive    Boolean  @default(false)
    externalId  String?
    provider    String?
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt

    addresses       Address[]
    orders          Order[]
    reviews         Review[]
    cart            Cart?
    wishlist        Wishlist?
    orderLogs       OrderLog[] // Log thay đổi trạng thái đơn hàng
    adminActivities AdminActivity[] // Hoạt động admin (nếu user là admin)
}

enum Role {
    CUSTOMER
    ADMIN
}

// ============================================
// ADDRESS
// ============================================

model Address {
    id          String   @id @default(auto()) @map("_id") @db.ObjectId
    userId      String   @db.ObjectId
    userName    String
    phoneNumber String // Đổi từ phone -> phoneNumber
    location    String? // Thêm: full address string từ DB2
    isDefault   Boolean  @default(false)
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt

    user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
    orders Order[]
}

// ============================================
// CATEGORY & PRODUCTS
// ============================================

model Category {
    id           String   @id @default(auto()) @map("_id") @db.ObjectId
    categoryName String
    isActive     Boolean  @default(true)
    createdAt    DateTime @default(now())
    updatedAt    DateTime @updatedAt

    subcategories Subcategory[]
}

model Subcategory {
    id              String   @id @default(auto()) @map("_id") @db.ObjectId
    categoryId      String   @db.ObjectId
    subcategoryName String
    isActive        Boolean  @default(true)
    createdAt       DateTime @default(now())
    updatedAt       DateTime @updatedAt

    category Category  @relation(fields: [categoryId], references: [id])
    products Product[]
}

model Product {
    id              String   @id @default(auto()) @map("_id") @db.ObjectId
    subcategoryId   String   @db.ObjectId
    ProductName     String // Đổi ProductName -> name
    description     String?
    price           Float
    discountedPrice Float?
    stockQuantity   Int
    imageUrl        String?
    createdAt       DateTime @default(now())
    isActive        Boolean  @default(true)
    sizes           Json?
    colors          Json?

    productVariants ProductVariant[]
    subcategory     Subcategory      @relation(fields: [subcategoryId], references: [id])
    productImages   ProductImage[]
    reviews         Review[]
    orderDetails    OrderDetail[] // Đổi từ orderItems
    wishlistDetails WishlistDetail[] // Đổi từ wishlistItems
}

model ProductImage {
    id          String  @id @default(auto()) @map("_id") @db.ObjectId
    productId   String  @db.ObjectId
    imageUrl    String
    isThumbnail Boolean @default(false)

    createdAt DateTime @default(now())
    product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model ProductVariant {
    id                     String   @id @default(auto()) @map("_id") @db.ObjectId
    productId              String   @db.ObjectId
    size                   String // Đổi từ name/type thành size cụ thể
    color                  String // Đổi từ name/type thành color cụ thể
    stockQuantity          Int
    variantPrice           Float?
    variantDiscountedPrice Float?
    variantImageUrl        String?
    isActive               Boolean  @default(true)
    createdAt              DateTime @default(now())
    updatedAt              DateTime @updatedAt

    product      Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
    cartDetails  CartDetail[]
    orderDetails OrderDetail[]
}

// ============================================
// CART
// ============================================

model Cart {
    id        String   @id @default(auto()) @map("_id") @db.ObjectId
    userId    String   @unique @db.ObjectId
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
    cartDetails CartDetail[]
}

model CartDetail {
    id               String   @id @default(auto()) @map("_id") @db.ObjectId
    cartId           String   @db.ObjectId
    productVariantId String?  @db.ObjectId // Nullable nếu sản phẩm không có variant
    quantity         Int      @default(1)
    unitPrice        Float // Thêm: lưu giá tại thời điểm add to cart
    createdAt        DateTime @default(now())
    updatedAt        DateTime @updatedAt

    cart           Cart            @relation(fields: [cartId], references: [id], onDelete: Cascade)
    productVariant ProductVariant? @relation(fields: [productVariantId], references: [id])
}

// ============================================
// WISHLIST
// ============================================

model Wishlist {
    id        String   @id @default(auto()) @map("_id") @db.ObjectId
    userId    String   @unique @db.ObjectId
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
    wishlistDetails WishlistDetail[] // Đổi items -> wishlistDetails
}

model WishlistDetail {
    id         String   @id @default(auto()) @map("_id") @db.ObjectId
    wishlistId String   @db.ObjectId
    productId  String   @db.ObjectId
    createdAt  DateTime @default(now())

    wishlist Wishlist @relation(fields: [wishlistId], references: [id], onDelete: Cascade)
    product  Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
}

// ============================================
// ORDER
// ============================================

model Order {
    id              String        @id @default(auto()) @map("_id") @db.ObjectId
    orderNumber     String        @unique // Mã đơn hàng hiển thị
    userId          String        @db.ObjectId
    addressId       String        @db.ObjectId
    status          OrderStatus   @default(PENDING)
    paymentMethodId String        @db.ObjectId
    paymentStatus   PaymentStatus @default(PENDING)

    // Tính toán tiền
    subtotal        Float // Tổng tiền hàng (chưa giảm giá)
    voucherId       String? @db.ObjectId // Voucher được áp dụng
    voucherDiscount Float   @default(0) // Số tiền được giảm từ voucher
    total           Float // Tổng tiền cuối cùng = subtotal - voucherDiscount

    // Thông tin khác
    note         String? // Ghi chú của khách hàng
    cancelReason String? // Lý do hủy đơn (nếu có)
    adminNote    String? // Ghi chú của admin

    // Timestamps
    createdAt   DateTime  @default(now())
    updatedAt   DateTime  @updatedAt
    confirmedAt DateTime? // Thời gian xác nhận
    shippedAt   DateTime? // Thời gian giao hàng
    deliveredAt DateTime? // Thời gian hoàn thành
    cancelledAt DateTime? // Thời gian hủy

    // Relations
    user          User          @relation(fields: [userId], references: [id])
    address       Address       @relation(fields: [addressId], references: [id])
    paymentMethod PaymentMethod @relation(fields: [paymentMethodId], references: [id])
    voucher       Voucher?      @relation(fields: [voucherId], references: [id])
    orderDetails  OrderDetail[]
    payment       Payment?
    orderLogs     OrderLog[] // Log thay đổi trạng thái

    @@index([userId])
    @@index([status])
    @@index([createdAt])
}

enum OrderStatus {
    PENDING
    CONFIRMED
    PROCESSING
    SHIPPING
    DELIVERED
    CANCELLED
}

enum PaymentStatus {
    PENDING
    PAID
    FAILED
    REFUNDED
}

model OrderDetail {
    id               String   @id @default(auto()) @map("_id") @db.ObjectId
    orderId          String   @db.ObjectId
    productId        String   @db.ObjectId
    productVariantId String?  @db.ObjectId // Thêm: support variant
    productName      String
    productImage     String
    variantName      String? // size + color
    price            Float // unitPrice
    quantity         Int
    subtotal         Float // Đổi total -> subtotal
    createdAt        DateTime @default(now())

    order          Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
    product        Product         @relation(fields: [productId], references: [id], onDelete: Restrict)
    productVariant ProductVariant? @relation(fields: [productVariantId], references: [id])
}

// ============================================
// PAYMENT
// ============================================

model Payment {
    id              String        @id @default(auto()) @map("_id") @db.ObjectId
    orderId         String        @unique @db.ObjectId
    paymentMethodId String        @db.ObjectId // Thêm: reference đến PaymentMethod
    amount          Float
    currency        String        @default("VND")
    status          PaymentStatus @default(PENDING)
    transactionId   String?
    paymentDate     DateTime      @default(now())
    gatewayData     Json?
    createdAt       DateTime      @default(now())
    updatedAt       DateTime      @updatedAt

    order         Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
    paymentMethod PaymentMethod @relation(fields: [paymentMethodId], references: [id])
}

model PaymentMethod {
    id          String      @id @default(auto()) @map("_id") @db.ObjectId
    name        String
    type        PaymentType // Thêm từ DB2
    description String?
    isActive    Boolean     @default(true)
    createdAt   DateTime    @default(now())
    updatedAt   DateTime    @updatedAt

    orders   Order[]
    payments Payment[]
}

enum PaymentType {
    COD
    VNPAY
}

// ============================================
// VOUCHER - CHỈ CHO HÀNG HÓA (KHÔNG SHIP)
// ============================================

model Voucher {
    id            String       @id @default(auto()) @map("_id") @db.ObjectId
    code          String       @unique
    name          String // Tên voucher hiển thị
    description   String? // Mô tả voucher
    discountType  DiscountType // PERCENTAGE hoặc FIXED_AMOUNT
    discountValue Float // Giá trị giảm (% hoặc VND)
    minOrderValue Float        @default(0) // Giá trị đơn hàng tối thiểu
    maxUsage      Int // Số lần sử dụng tối đa 
    currentUsage  Int          @default(0) // Số lần đã sử dụng
    isActive      Boolean      @default(true)
    startDate     DateTime // Ngày bắt đầu có hiệu lực
    endDate       DateTime // Ngày hết hạn
    createdAt     DateTime     @default(now())
    updatedAt     DateTime     @updatedAt

    // Relations
    orders Order[]

    @@index([isActive])
}

enum DiscountType {
    PERCENTAGE // Giảm theo phần trăm cố định
    FIXED // Giảm số tiền cố định
}

// ============================================
// REVIEW
// ============================================

model Review {
    id         String   @id @default(auto()) @map("_id") @db.ObjectId
    userId     String   @db.ObjectId
    productId  String   @db.ObjectId
    rating     Int // Giữ Int đơn giản hơn enum Rating của DB2
    comment    String?
    images     String[]
    isVerified Boolean  @default(false)
    isActive   Boolean  @default(true)
    createdAt  DateTime @default(now())
    updatedAt  DateTime @updatedAt

    user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
    product Product @relation(fields: [productId], references: [id], onDelete: Restrict)
}

// ============================================
// BANNER
// ============================================

model Banner {
    id          String    @id @default(auto()) @map("_id") @db.ObjectId
    title       String
    description String?
    image       String
    link        String?
    order       Int       @default(0)
    isActive    Boolean   @default(true)
    startDate   DateTime?
    endDate     DateTime?
    createdAt   DateTime  @default(now())
    updatedAt   DateTime  @updatedAt
}

// ============================================
// TOKEN
// ============================================

model VerifyToken {
    id        String   @id @default(auto()) @map("_id") @db.ObjectId
    userId    String
    token     String
    expiresAt DateTime
    used      Boolean  @default(false)
    createdAt DateTime @default(now())
}

model PasswordResetToken {
    id        String   @id @default(auto()) @map("_id") @db.ObjectId
    userId    String
    token     String
    expiresAt DateTime
    used      Boolean  @default(false)
    createdAt DateTime @default(now())
}

// ============================================
// ORDER LOG - THEO DÕI THAY ĐỔI TRẠNG THÁI
// ============================================

model OrderLog {
    id        String       @id @default(auto()) @map("_id") @db.ObjectId
    orderId   String       @db.ObjectId
    userId    String?      @db.ObjectId // User thực hiện thay đổi (null = system)
    oldStatus OrderStatus? // Trạng thái cũ (null nếu tạo mới)
    newStatus OrderStatus // Trạng thái mới
    reason    String? // Lý do thay đổi
    note      String? // Ghi chú thêm
    createdAt DateTime     @default(now())

    order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
    user  User? @relation(fields: [userId], references: [id])

    @@index([orderId])
    @@index([createdAt])
}

// ============================================
// SYSTEM LOGS - LOG HỆ THỐNG
// ============================================

model SystemLog {
    id        String   @id @default(auto()) @map("_id") @db.ObjectId
    level     LogLevel // ERROR, WARN, INFO, DEBUG
    category  String // AUTH, ORDER, PAYMENT, VOUCHER, etc
    action    String // LOGIN, CREATE_ORDER, APPLY_VOUCHER, etc
    message   String // Nội dung log
    userId    String?  @db.ObjectId // User liên quan (nếu có)
    metadata  Json? // Dữ liệu thêm (request, response, error details)
    ipAddress String? // IP address
    userAgent String? // User agent
    createdAt DateTime @default(now())

    @@index([level])
    @@index([category])
    @@index([createdAt])
    @@index([userId])
}

enum LogLevel {
    ERROR
    WARN
    INFO
    DEBUG
}

// ============================================
// SYSTEM SETTINGS - CẤU HÌNH HỆ THỐNG
// ============================================

model SystemSetting {
    id          String   @id @default(auto()) @map("_id") @db.ObjectId
    key         String   @unique // Khóa cấu hình
    value       String // Giá trị cấu hình
    description String? // Mô tả
    dataType    String   @default("string") // string, number, boolean, json
    category    String   @default("general") // general, payment, shipping, etc
    isActive    Boolean  @default(true)
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt

    @@index([category])
}

// ============================================
// ADMIN ACTIVITIES - HOẠT ĐỘNG ADMIN
// ============================================

model AdminActivity {
    id          String   @id @default(auto()) @map("_id") @db.ObjectId
    adminId     String   @db.ObjectId
    action      String // CREATE_PRODUCT, UPDATE_ORDER, DELETE_USER, etc
    targetType  String // PRODUCT, ORDER, USER, VOUCHER, etc
    targetId    String? // ID của đối tượng bị tác động
    description String // Mô tả hành động
    metadata    Json? // Dữ liệu thêm
    ipAddress   String?
    userAgent   String?
    createdAt   DateTime @default(now())

    admin User @relation(fields: [adminId], references: [id])

    @@index([adminId])
    @@index([action])
    @@index([targetType])
    @@index([createdAt])
}
